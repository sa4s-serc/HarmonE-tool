<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonica</title>
    <script src="https://unpkg.com/tailwindcss-jit-cdn@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="icon" href="data:,">

    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .tab-active { border-bottom-color: #3b82f6 !important; color: #3b82f6; }
        
        /* Light mode card shadows */
        .card-shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .card-shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="h-full text-gray-900 font-sans bg-gray-50">
    
    <div id="welcome-screen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg card-shadow-lg max-w-2xl w-full">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome to Harmonica's Adaptation Control Plane</h2>
            <p class="text-gray-600 mb-6">Choose an approach to begin. This will reset any previous data and start a fresh monitoring session.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    
                <div class="p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-900 text-lg mb-3 border-b border-gray-300 pb-2">Regression (LSTM/SVM/Linear)</h3>
                    <div class="space-y-3">
                        <button id="modal-btn-reg-harmone" class="text-left w-full p-3 bg-gray-200 hover:bg-blue-100 rounded-lg transition-colors border border-gray-300">
                            <h4 class="font-semibold text-gray-900">HarmonE (Score/Drift)</h4>
                            <p class="text-sm text-gray-700">Full logic orchestrated by ACP.</p>
                        </button>
                        <button id="modal-btn-reg-switch" class="text-left w-full p-3 bg-gray-200 hover:bg-blue-100 rounded-lg transition-colors border border-gray-300">
                            <h4 class="font-semibold text-gray-900">Simple R² Switch</h4>
                            <p class="text-sm text-gray-700">Baseline: Switch on R² score drop.</p>
                        </button>
                        <button id="modal-btn-reg-single" class="text-left w-full p-3 bg-gray-200 hover:bg-blue-100 rounded-lg transition-colors border border-gray-300">
                            <h4 class="font-semibold text-gray-900">Single Model (Monitor-Only)</h4>
                            <p class="text-sm text-gray-700">Run one model, monitor only.</p>
                        </button>
                    </div>
                </div>
            
                <div class="p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-900 text-lg mb-3 border-b border-gray-300 pb-2">Computer Vision (YOLO)</h3>
                    <div class="space-y-3">
                        <button id="modal-btn-cv-harmone" class="text-left w-full p-3 bg-gray-200 hover:bg-blue-100 rounded-lg transition-colors border border-gray-300">
                            <h4 class="font-semibold text-gray-900">HarmonE (Score/Drift)</h4>
                            <p class="text-sm text-gray-700">Full logic orchestrated by ACP.</p>
                        </button>
                        <button id="modal-btn-cv-switch" class="text-left w-full p-3 bg-gray-200 hover:bg-blue-100 rounded-lg transition-colors border border-gray-300">
                            <h4 class="font-semibold text-gray-900">Simple Confidence Switch</h4>
                            <p class="text-sm text-gray-700">Baseline: Switch on confidence drop.</p>
                        </button>
                        <button id="modal-btn-cv-single" class="text-left w-full p-3 bg-gray-200 hover:bg-blue-100 rounded-lg transition-colors border border-gray-300">
                            <h4 class="font-semibold text-gray-900">Single Model (Monitor-Only)</h4>
                            <p class="text-sm text-gray-700">Run one model, monitor only.</p>
                        </button>
                    </div>
                </div>
            
                <div class="md:col-span-2">
                    <button id="modal-btn-custom" class="text-left w-full p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-200">
                        <h3 class="font-semibold text-gray-900">Build Custom System</h3>
                        <p class="text-sm text-gray-600">Go to the Policy Manager to define your own system from scratch.</p>
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="model-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg card-shadow-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Select Model to Run</h3>
            <p class="text-gray-600 mb-6">Choose which model you want to run in single model mode:</p>
            
            <div class="space-y-3">
                <select id="model-dropdown" class="w-full bg-white border border-gray-300 text-gray-900 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button id="confirm-model-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    Start Single Model Run
                </button>
                <button id="cancel-model-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Custom System Upload Modal -->
    <div id="custom-upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg card-shadow-lg max-w-lg w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Build Custom System</h3>
            <p class="text-gray-600 mb-4">Select the base inference engine and upload your custom MAPE Python files (monitor.py, plan.py, etc.).</p>

            <form id="custom-upload-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Base System (Inference Engine)</label>
                    <select id="custom-base-system" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500">
                        <option value="regression">Regression (LSTM/SVM/Linear)</option>
                        <option value="cv">Computer Vision (YOLO)</option>
                    </select>
                </div>

                <!-- NEW: Dataset Upload Input -->
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Upload Dataset (Optional)</label>
                    <input type="file" id="custom-dataset-input" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <!-- This hint text changes based on selection -->
                    <p id="dataset-hint" class="text-xs text-gray-500 mt-1">
                        For Regression: Upload <strong>dataset.csv</strong>
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Upload MAPE Files</label>
                    <input type="file" id="custom-file-input" multiple accept=".py" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <p class="text-xs text-gray-500 mt-1">Allowed: monitor.py, analyse.py, plan.py, execute.py, manage.py</p>
                </div>

                <div id="upload-status" class="hidden p-2 text-sm rounded bg-gray-100"></div>

                <div class="flex space-x-3 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        Upload & Build
                    </button>
                    <button type="button" id="cancel-custom-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="dashboard-wrapper" class="hidden flex flex-col h-screen">

        <header class="bg-white border-b border-gray-200 card-shadow z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">

                <button id="back-to-menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1.5 rounded-md text-sm font-medium transition-colors">
                    &larr; Change Approach
                </button>

                <h1 class="text-2xl font-bold text-gray-900 hidden md:block">Harmonica</h1>
                
                <div class="flex items-center space-x-2">
                    <label for="policy-id-input" class="text-sm font-medium text-gray-700">Policy ID:</label>
                    <input type="text" id="policy-id-input" value="harmone_score_policy" class="bg-white border border-gray-300 text-gray-900 px-3 py-1.5 rounded-md text-sm w-48 md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter policy ID to load...">
                    <button id="load-policy-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md text-sm font-medium transition-colors">Load</button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4 lg:p-8">
            <div class="max-w-7xl mx-auto">
                
                <nav class="mb-6 border-b border-gray-300">
                    <ul class="flex space-x-8">
                        <li><button class="tab-btn text-gray-600 hover:text-gray-900 py-2 border-b-2 border-transparent transition-colors" data-tab="policy">Policy Management (KR1)</button></li>
                        <li><button class="tab-btn text-gray-600 hover:text-gray-900 py-2 border-b-2 border-transparent transition-colors tab-active" data-tab="dashboard">Live Dashboard (KR2)</button></li>
                        </ul>
                </nav>

                <div id="message-container" class="hidden text-center p-4 rounded-md mb-4"></div>

                <div class="tab-content" id="dashboard-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Live Telemetry: <span id="policy-title-dashboard" class="text-blue-600">No Policy Loaded</span></h2>
                        
                        <button id="download-telemetry-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1.5 rounded-md text-sm font-medium transition-colors">
                            Download Telemetry (CSV)
                        </button>
                    </div>

                    <div id="adaptive-start-container" class="mb-4 hidden flex justify-center">
                        <button id="adaptive-start-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md text-base font-medium transition-colors">
                            Start Managed System
                        </button>
                    </div>
                    
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-3 bg-white p-6 rounded-lg card-shadow border border-gray-200">
                            <h3 id="main-chart-title" class="text-lg font-medium mb-4 text-gray-900">Main Metric</h3>
                            <div class="h-80"><canvas id="main-metric-chart"></canvas></div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg card-shadow border border-gray-200">
                            <h3 id="qa1-chart-title" class="text-lg font-medium mb-4 text-gray-900">Associated QA 1</h3>
                            <div class="h-60"><canvas id="qa1-chart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg card-shadow border border-gray-200">
                            <h3 id="qa2-chart-title" class="text-lg font-medium mb-4 text-gray-900">Associated QA 2</h3>
                            <div class="h-60"><canvas id="qa2-chart"></canvas></div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg card-shadow border border-gray-200">
                            <h3 id="model-chart-title" class="text-lg font-medium mb-4 text-gray-900">Model Distribution</h3>
                            <div class="h-60" style="position: relative; max-height: 240px;"><canvas id="model-chart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content hidden" id="policy-content">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900">Policy Management (KR1)</h2>
                    
                    <div class="mb-4">
                        <label for="policy-presets" class="block text-sm font-medium mb-1 text-gray-700">Load Preset:</label>
                        <select id="policy-presets" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Select a preset --</option>
                            <optgroup label="Regression Presets">
                                <option value="reg_harmone_score">REG: HarmonE Score Policy</option>
                                <option value="reg_switch_r2">REG: Simple R² Switch Policy</option>
                            </optgroup>
                            <optgroup label="Computer Vision Presets">
                                <option value="cv_harmone_score">CV: HarmonE Score Policy</option>
                                <option value="cv_switch_conf">CV: Simple Confidence Switch</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <form id="policy-form" class="bg-white p-6 rounded-lg card-shadow space-y-6 border border-gray-200">
                        
                        <fieldset class="border border-gray-300 p-4 rounded-md">
                            <legend class="text-lg font-medium px-2 text-gray-900">General</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div>
                                    <label for="form-policy-id" class="block text-sm font-medium mb-1 text-gray-700">Policy ID</label>
                                    <input type="text" id="form-policy-id" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="form-metric" class="block text-sm font-medium mb-1 text-gray-700">Metric to Watch (quality_attribute)</label>
                                    <input type="text" id="form-metric" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="border border-gray-300 p-4 rounded-md">
                            <legend class="text-lg font-medium px-2 text-gray-900">Adaptation Boundary (Primary)</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div>
                                    <label for="form-condition" class="block text-sm font-medium mb-1 text-gray-700">Condition</label>
                                    <select id="form-condition" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="LESS_THAN">LESS_THAN</option>
                                        <option value="GREATER_THAN">GREATER_THAN</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="form-threshold" class="block text-sm font-medium mb-1 text-gray-700">Static Threshold</label>
                                    <input type="number" step="0.01" id="form-threshold" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="border border-gray-300 p-4 rounded-md">
                            <legend class="text-lg font-medium px-2 text-gray-900">Adaptation Boundary (Secondary)</legend>
                            <div id="secondary-boundaries-container" class="space-y-4 mt-2">
                                <div class="secondary-boundary-group border border-gray-200 p-3 rounded-md space-y-2 bg-gray-50">
                                    <h4 class="font-medium text-gray-700">Secondary Boundary 1</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Metric (QA)</label>
                                            <input type="text" class="sec-boundary-metric w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Condition</label>
                                            <select class="sec-boundary-condition w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="LESS_THAN">LESS_THAN</option>
                                                <option value="GREATER_THAN">GREATER_THAN</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Threshold</label>
                                            <input type="number" step="0.01" class="sec-boundary-threshold w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Tactic ID</label>
                                            <input type="text" class="sec-boundary-tactic-id w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                        </div>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="button" class="remove-sec-boundary-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="add-sec-boundary-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm">+ Add Secondary Boundary</button>
                        </fieldset>
                        <fieldset class="border border-gray-300 p-4 rounded-md">
                            <legend class="text-lg font-medium px-2 text-gray-900">Tactics (Primary)</legend>
                            <div id="tactics-container" class="space-y-4 mt-2">
                                <div class="tactic-group border border-gray-200 p-3 rounded-md space-y-2 bg-gray-50">
                                    <h4 class="font-medium text-gray-700">Tactic 1</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Tactic ID</label>
                                            <input type="text" class="tactic-id w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Priority</label>
                                            <input type="number" value="1" class="tactic-priority w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium mb-1 text-gray-700">Tactic Endpoint URL</label>
                                            <input type="text" class="tactic-endpoint w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="http://localhost:8080/adaptor/tactic" required>
                                        </div>
                                        <div class="flex items-end">
                                            <button type="button" class="remove-tactic-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="add-tactic-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm">+ Add Tactic</button>
                        </fieldset>

                        <fieldset class="border border-gray-300 p-4 rounded-md">
                            <legend class="text-lg font-medium px-2 text-gray-900">Associated QAs</legend>
                             <div>
                                <label for="form-qas" class="block text-sm font-medium mb-1 text-gray-700">Associated Metrics (comma-separated)</label>
                                <input type="text" id="form-qas" class="w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., r2_score,normalized_energy,model_used">
                            </div>
                        </fieldset>
                        
                        <div class="flex space-x-4">
                            <button type="button" id="save-policy-folder-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md text-base font-medium transition-colors">
                                 Save as Policy
                            </button>
                            <button type="button" id="download-policy-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-md text-base font-medium transition-colors">
                                 Download File
                            </button>
                        </div>
                    </form>
                </div>

                <div class="tab-content hidden" id="history-content">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900">Adaptation History & Analysis (KR3)</h2>
                    <div id="history-feed" class="space-y-6">
                        <div class="text-gray-500">No adaptation events recorded yet.</div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // === CONFIGURATION ===
        const ACP_SERVER_URL = "http://localhost:5000";
        const POLLING_INTERVAL = 1000;
        const CHART_MAX_DATA_POINTS = 30;

        // === GLOBAL STATE ===
        let currentPolicyId = "";
        let pollingIntervalId = null;
        let chartInstances = {};
        let globalKnowledge = { telemetry_history: [] };
        let currentSystemType = ""; // Track current system type for modal

        // === DOM ELEMENTS ===
        const welcomeScreen = document.getElementById('welcome-screen');
        const dashboardWrapper = document.getElementById('dashboard-wrapper');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const modelSelectionModal = document.getElementById('model-selection-modal');
        const modelDropdown = document.getElementById('model-dropdown');
        const confirmModelBtn = document.getElementById('confirm-model-btn');
        const cancelModelBtn = document.getElementById('cancel-model-btn');

        const loadPolicyBtn = document.getElementById('load-policy-btn');
        const policyIdInput = document.getElementById('policy-id-input');
        const messageContainer = document.getElementById('message-container');
        
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const policyForm = document.getElementById('policy-form');
        const addTacticBtn = document.getElementById('add-tactic-btn');
        const tacticsContainer = document.getElementById('tactics-container');

        // NEW SECONDARY BOUNDARY ELEMENTS
        const addSecBoundaryBtn = document.getElementById('add-sec-boundary-btn');
        const secondaryBoundariesContainer = document.getElementById('secondary-boundaries-container');


        const downloadPolicyBtn = document.getElementById('download-policy-btn');
        const downloadTelemetryBtn = document.getElementById('download-telemetry-btn');

        const customUploadModal = document.getElementById('custom-upload-modal');
        const customUploadForm = document.getElementById('custom-upload-form');
        const cancelCustomBtn = document.getElementById('cancel-custom-btn');
        const uploadStatus = document.getElementById('upload-status');

        const customBaseSystemSelect = document.getElementById('custom-base-system');
        const customDatasetInput = document.getElementById('custom-dataset-input');
        const datasetHint = document.getElementById('dataset-hint');
        
        // ▼▼▼ 1. PRESETS ▼▼▼
        const HARMONY_PRESETS = {
            // --- REGRESSION PRESETS ---
            "reg_harmone_score": {
                policy_id: "reg_harmone_score",
                quality_attribute: "score", 
                adaptation_boundary: { type: "STATIC_THRESHOLD", condition: "LESS_THAN", threshold: 0.78 },
                tactics: [ { tactic_id: "execute_mape_plan", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic" } ],
                secondary_boundaries: [ // ADDED KL_DIV SECONDARY BOUNDARY
                    {
                        quality_attribute: "kl_div",
                        condition: "GREATER_THAN", 
                        threshold: 0.10, // Changed threshold to 0.10 as per request
                        tactic_id: "handle_data_drift"
                    }
                ],
                associated_qas: ["r2_score", "normalized_energy", "model_used"]
            },
            "reg_harmone_drift": {
                policy_id: "reg_harmone_drift",
                quality_attribute: "kl_div", 
                adaptation_boundary: { condition: "GREATER_THAN", threshold: 0.75 },
                tactics: [ { tactic_id: "handle_data_drift", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic" } ],
                associated_qas: ["kl_div", "model_used"]
            },
            "reg_switch_r2": {
                policy_id: "reg_switch_r2",
                quality_attribute: "r2_score", 
                adaptation_boundary: { condition: "LESS_THAN", threshold: 0.70 },
                tactics: [ { tactic_id: "switch_model_r2_baseline", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic" } ],
                associated_qas: ["r2_score", "normalized_energy", "model_used"] // Simple switch - no kl_div needed
            },
            
            // --- CV PRESETS ---
            "cv_harmone_score": {
                policy_id: "cv_harmone_score",
                quality_attribute: "score", 
                adaptation_boundary: { type: "STATIC_THRESHOLD", condition: "LESS_THAN", threshold: 0.54 },
                tactics: [ { tactic_id: "execute_mape_plan", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic" } ],
                secondary_boundaries: [
                    {
                        quality_attribute: "kl_div",
                        condition: "GREATER_THAN", 
                        threshold: 0.07,
                        tactic_id: "handle_data_drift"
                    }
                ],
                associated_qas: ["confidence", "normalized_energy", "model_used"]
            },
            "cv_harmone_drift": {
                policy_id: "cv_harmone_drift",
                quality_attribute: "kl_div", 
                adaptation_boundary: { condition: "GREATER_THAN", threshold: 0.07 },
                tactics: [ { tactic_id: "handle_data_drift", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic" } ],
                associated_qas: ["kl_div", "model_used"]
            },
            "cv_switch_conf": {
                policy_id: "cv_switch_confidence",
                quality_attribute: "confidence", 
                adaptation_boundary: { condition: "LESS_THAN", threshold: 0.70 },
                tactics: [ { tactic_id: "switch_model_r2_baseline", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic" } ],
                associated_qas: ["confidence", "normalized_energy", "model_used"] // Simple switch - no kl_div needed
            }
        };

        // === HELPER: RESET SERVER KNOWLEDGE ===
        // === HELPER: RESET SERVER KNOWLEDGE ===
        async function resetServerKnowledge() {
            try {
                // 1. Clear local state first
                globalKnowledge = { telemetry_history: [], intervention_logs: [] };

                // 2. FORCE CLEAR PIE CHART (Fixes the "Ghost Model" issue)
                if (chartInstances.modelChart) {
                    chartInstances.modelChart.data.labels = [];
                    chartInstances.modelChart.data.datasets.forEach(dataset => {
                        dataset.data = [];
                    });
                    chartInstances.modelChart.update();
                }
                
                // 3. Update other charts to empty
                updateDashboardCharts(globalKnowledge);
                
                // 4. Tell server to reset
                await fetch(`${ACP_SERVER_URL}/api/reset`, { method: 'POST' });
                console.log("Server knowledge reset successfully.");
            } catch (err) {
                console.error("Failed to reset server knowledge:", err);
            }
        }

        // === HELPER FUNCTION TO SWITCH VIEWS ===
        const showView = (viewName) => {
            if (viewName === 'dashboard') {
                welcomeScreen.classList.add('hidden');
                dashboardWrapper.classList.remove('hidden');
            } else { // 'welcome'
                dashboardWrapper.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                
                if (pollingIntervalId) clearInterval(pollingIntervalId);
                pollingIntervalId = null;
                currentPolicyId = "";
                policyIdInput.value = ""; 
                document.getElementById('policy-title-dashboard').textContent = 'No Policy Loaded';
                showMessage("Polling stopped. Select an approach.", "info");
            }
        };

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {

            // ▼▼▼ VIEW NAVIGATION LOGIC (WITH "single" FIX) ▼▼▼
            backToMenuBtn.addEventListener('click', async () => {
                // First, shutdown any running managed systems
                try {
                    showMessage("Shutting down current system...", "info");
                    const response = await fetch(`${ACP_SERVER_URL}/api/shutdown-system`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        showMessage("System shutdown completed", "success");
                        
                        // Clear all chart data
                        Object.values(chartInstances).forEach(chart => {
                            if (chart) {
                                chart.data.labels = [];
                                chart.data.datasets.forEach(dataset => {
                                    dataset.data = [];
                                });
                                chart.update();
                            }
                        });
                        
                        // Reset global state
                        globalKnowledge = { telemetry_history: [] };
                        
                        // Stop polling
                        if (pollingIntervalId) {
                            clearInterval(pollingIntervalId);
                            pollingIntervalId = null;
                        }
                        
                        // Clear history feed
                        const historyFeed = document.getElementById('history-feed');
                        if (historyFeed) {
                            historyFeed.innerHTML = '<p class="text-gray-500 text-center py-8">No adaptation events yet</p>';
                        }
                        
                    } else {
                        showMessage("Warning: Could not cleanly shutdown system", "warning");
                    }
                } catch (error) {
                    console.error('Error during shutdown:', error);
                    showMessage("Warning: Shutdown may not have completed cleanly", "warning");
                }
                
                // Always switch back to welcome screen
                showView('welcome');
            });

            // REGRESSION BUTTONS
            document.getElementById('modal-btn-reg-harmone').addEventListener('click', async () => {
                await resetServerKnowledge(); // <--- RESET ADDED
                populateFormWithPreset(HARMONY_PRESETS.reg_harmone_score);
                policyIdInput.value = HARMONY_PRESETS.reg_harmone_score.policy_id;
                document.getElementById('policy-presets').value = 'reg_harmone_score';
                showMessage("Loaded 'REG: HarmonE Demo' preset. Click 'Start Managed System' to begin", "info");
                showView('dashboard');
                document.querySelector('.tab-btn[data-tab="policy"]').click();
                await writeApproachConfig('reg_harmone_score');
                await savePolicyToFolder(); 
                document.getElementById("adaptive-start-container").classList.remove("hidden");
            });

            document.getElementById('modal-btn-reg-switch').addEventListener('click', async () => {
                await resetServerKnowledge(); // <--- RESET ADDED
                populateFormWithPreset(HARMONY_PRESETS.reg_switch_r2);
                policyIdInput.value = HARMONY_PRESETS.reg_switch_r2.policy_id;
                document.getElementById('policy-presets').value = 'reg_switch_r2';
                showMessage("Loaded 'REG: Simple R² Switch' preset. Click 'Start Managed System' to begin", "info");
                showView('dashboard');
                document.querySelector('.tab-btn[data-tab="policy"]').click();
                await writeApproachConfig('reg_switch_r2');
                await savePolicyToFolder(); 
                document.getElementById("adaptive-start-container").classList.remove("hidden");
            });

            document.getElementById('modal-btn-reg-single').addEventListener('click', () => {
                currentSystemType = "regression";
                showModelSelectionModal();
            });

            // CV BUTTONS
            document.getElementById('modal-btn-cv-harmone').addEventListener('click', async () => {
                await resetServerKnowledge(); // <--- RESET ADDED
                populateFormWithPreset(HARMONY_PRESETS.cv_harmone_score);
                policyIdInput.value = HARMONY_PRESETS.cv_harmone_score.policy_id;
                document.getElementById('policy-presets').value = 'cv_harmone_score';
                showMessage("Loaded 'CV: HarmonE Demo' preset. Click 'Start Managed System' to begin", "info");
                showView('dashboard');
                document.querySelector('.tab-btn[data-tab="policy"]').click();
                await writeApproachConfig('cv_harmone_score');
                await savePolicyToFolder(); 
                document.getElementById("adaptive-start-container").classList.remove("hidden");
            });

            document.getElementById('modal-btn-cv-switch').addEventListener('click', async () => {
                await resetServerKnowledge(); // <--- RESET ADDED
                populateFormWithPreset(HARMONY_PRESETS.cv_switch_conf);
                policyIdInput.value = HARMONY_PRESETS.cv_switch_conf.policy_id;
                document.getElementById('policy-presets').value = 'cv_switch_conf';
                showMessage("Loaded 'CV: Simple Confidence Switch' preset. Click 'Start Managed System' to begin", "info");
                showView('dashboard');
                document.querySelector('.tab-btn[data-tab="policy"]').click();
                await writeApproachConfig('cv_switch_conf');
                await savePolicyToFolder(); 
                document.getElementById("adaptive-start-container").classList.remove("hidden");
            });

            document.getElementById('modal-btn-cv-single').addEventListener('click', () => {
                currentSystemType = "cv";
                showModelSelectionModal();
            });

            // CUSTOM BUTTON
            document.getElementById('modal-btn-custom').addEventListener('click', async () => {
                // Show the upload modal instead of jumping straight to policy view
                customUploadModal.classList.remove('hidden');
                uploadStatus.classList.add('hidden');
                document.getElementById('custom-file-input').value = ""; // Clear previous
            });
            
            // 2. Handle Cancel
            cancelCustomBtn.addEventListener('click', () => {
                customUploadModal.classList.add('hidden');
            });

            // 1. NEW: Handle Dropdown Change to update Dataset Hint
            customBaseSystemSelect.addEventListener('change', () => {
                const mode = customBaseSystemSelect.value;
                // Clear previous input
                customDatasetInput.value = ""; 

                if (mode === 'regression') {
                    customDatasetInput.setAttribute('accept', '.csv');
                    datasetHint.innerHTML = "For Regression: Upload <strong>dataset.csv</strong>";
                } else {
                    customDatasetInput.setAttribute('accept', '.zip');
                    datasetHint.innerHTML = "For CV: Upload a <strong>.zip</strong> file containing your images";
                }
            });

            // 2. Trigger change once on load to set initial state
            customBaseSystemSelect.dispatchEvent(new Event('change'));


            // 3. Handle Form Submit (File Upload)
            customUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fileInput = document.getElementById('custom-file-input');
                const datasetInput = document.getElementById('custom-dataset-input'); // <--- Get input
                const baseSystem = document.getElementById('custom-base-system').value;
                
                if (fileInput.files.length === 0) {
                    alert("Please select at least one MAPE file.");
                    return;
                }
            
                const formData = new FormData();
                formData.append('base_system', baseSystem);
                
                // Add MAPE files
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('files[]', fileInput.files[i]);
                }
            
                // NEW: Add Dataset file if present
                if (datasetInput.files.length > 0) {
                    formData.append('dataset', datasetInput.files[0]);
                }
                
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('files[]', fileInput.files[i]);
                }
            
                uploadStatus.textContent = "Uploading and building system...";
                uploadStatus.className = "p-2 text-sm rounded bg-blue-100 text-blue-700 block";
                uploadStatus.classList.remove('hidden');
            
                try {
                    await resetServerKnowledge(); // Clear old data
            
                    const response = await fetch(`${ACP_SERVER_URL}/api/upload-custom-mape`, {
                        method: 'POST',
                        body: formData // No Content-Type header (browser sets it for FormData)
                    });
            
                    const result = await response.json();
            
                    if (response.ok) {
                        uploadStatus.textContent = "Success! " + result.message;
                        uploadStatus.className = "p-2 text-sm rounded bg-green-100 text-green-700 block";
                        
                        setTimeout(() => {
                            customUploadModal.classList.add('hidden');
                            
                            // --- START OF CHANGE ---
        
                            // 1. Determine the correct policy ID prefix based on the selected base system
                            // The wrapper expects the policy filename to match the approach name in approach.conf
                            let requiredPrefix = "";
                            if (baseSystem === "regression") {
                                requiredPrefix = "custom_regression";
                            } else {
                                requiredPrefix = "custom_cv";
                            }
                        
                            const generatedPolicyId = `${requiredPrefix}_policy`;
                        
                            // 2. Load the template with the CORRECT ID
                            const customTemplate = {
                                policy_id: generatedPolicyId, // e.g. "custom_regression_policy"
                                quality_attribute: "score", 
                                adaptation_boundary: { condition: "LESS_THAN", threshold: 0.5 },
                                secondary_boundaries: [], 
                                tactics: [{tactic_id: "execute_mape_plan", priority: 1, tactic_endpoint: "http://localhost:8080/adaptor/tactic"}],
                                associated_qas: ["score", "normalized_energy", "model_used"]
                            };

                            populateFormWithPreset(customTemplate); 
                            policyIdInput.value = generatedPolicyId;
                            currentPolicyId = generatedPolicyId; 

                            document.getElementById('policy-presets').value = '';
                            showMessage(`Custom system built. Created policy '${generatedPolicyId}'.`, "success");

                            showView('dashboard');

                            // 3. Automatically save this new valid policy to the folder so the Wrapper finds it
                            document.querySelector('.tab-btn[data-tab="policy"]').click();
                            setFieldsEditability(true);
                            savePolicyToFolder(); // <--- Crucial: This writes the file to /policies immediately
                        
                            // 4. Show the start button
                            document.getElementById("adaptive-start-container").classList.remove("hidden");

                            // --- END OF CHANGE ---
            
                        }, 1000);
                    } else {
                        throw new Error(result.error || "Upload failed");
                    }
            
                } catch (error) {
                    console.error(error);
                    uploadStatus.textContent = "Error: " + error.message;
                    uploadStatus.className = "p-2 text-sm rounded bg-red-100 text-red-700 block";
                }
            });

            // Modal event handlers
            confirmModelBtn.addEventListener('click', handleModelSelection);
            cancelModelBtn.addEventListener('click', hideModelSelectionModal);
            
            // Close modal when clicking outside
            modelSelectionModal.addEventListener('click', (e) => {
                if (e.target === modelSelectionModal) {
                    hideModelSelectionModal();
                }
            });

            // Tab switching logic
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('tab-active', 'text-blue-500'));
                    tab.classList.add('tab-active', 'text-blue-500');
                    
                    const tabId = tab.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        if (content.id === `${tabId}-content`) {
                            content.classList.remove('hidden');
                        }
                    });
                });
            });

            // Preset dropdown listener
            const presetDropdown = document.getElementById('policy-presets');
            presetDropdown.addEventListener('change', (e) => {
                const presetKey = e.target.value;
                if (presetKey && HARMONY_PRESETS[presetKey]) {
                    populateFormWithPreset(HARMONY_PRESETS[presetKey]);
                    showMessage(`Loaded preset '${presetKey}'. Review and click 'Generate File' or 'Update Live'.`, "info");
                } else if (presetKey === '') {
                    // When clearing selection, enable custom mode
                    setFieldsEditability(true);
                }
            });
            
            // Load Policy button
            loadPolicyBtn.addEventListener('click', loadPolicy);

            // Policy Form listeners
            policyForm.addEventListener('submit', handlePolicySubmit);
            addTacticBtn.addEventListener('click', () => addTacticGroup());
            downloadPolicyBtn.addEventListener('click', handlePolicyDownload);
            document.getElementById('save-policy-folder-btn').addEventListener('click', savePolicyToFolder);
            
            // Tactic removal logic
            tacticsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-tactic-btn')) {
                    if (tacticsContainer.children.length > 1) {
                        e.target.closest('.tactic-group').remove();
                        updateTacticHeaders();
                    }
                }
            });

            // NEW: Secondary Boundary Logic
            addSecBoundaryBtn.addEventListener('click', () => addSecBoundaryGroup());
            secondaryBoundariesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-sec-boundary-btn')) {
                    e.target.closest('.secondary-boundary-group').remove();
                    updateSecBoundaryHeaders();
                }
            });


            downloadTelemetryBtn.addEventListener('click', handleTelemetryDownload);
            initializeCharts();
            document.querySelector('.tab-btn[data-tab="dashboard"]').click();
        });
        
        // === CHARTING (KR2) ===

        // ▼▼▼ 2. UPDATED INITIALIZE CHARTS (Added annotation plugin to options) ▼▼▼
        function initializeCharts() {
            const lineChartConfig = (title) => ({
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            type: 'time',
                            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
                            ticks: { color: '#6b7280' },  // Light mode: gray-500
                            grid: { color: '#e5e7eb' }    // Light mode: gray-200
                        },
                        y: { 
                            ticks: { color: '#6b7280' },  // Light mode: gray-500
                            grid: { color: '#e5e7eb' }   // Light mode: gray-200
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#374151' } }, // Light mode: gray-700
                        tooltip: { mode: 'index', intersect: false },
                        annotation: { // Include annotation plugin here
                            annotations: {}
                        }
                    },
                    animation: { duration: 0 }
                }
            });
            
            const doughnutChartConfig = (title) => ({
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#374151' } // Light mode: gray-700
                        },
                        title: { display: false, text: title }
                    },
                    animation: { duration: 0 }
                }
            });

            chartInstances.main = new Chart(document.getElementById('main-metric-chart'), lineChartConfig("Main Metric"));
            chartInstances.qa1 = new Chart(document.getElementById('qa1-chart'), lineChartConfig("QA 1"));
            chartInstances.qa2 = new Chart(document.getElementById('qa2-chart'), lineChartConfig("QA 2"));
            chartInstances.modelChart = new Chart(document.getElementById('model-chart'), doughnutChartConfig("Model Distribution"));
        }

        // ▼▼▼ 3. UPDATED DASHBOARD CHARTS FUNCTION (ANNOTATIONS FIX + DATA FLUSH) ▼▼▼
        function updateDashboardCharts(data) {
            const policy = data.policy || {};
            const telemetry = data.telemetry_history || [];
            const interventions = data.intervention_logs || [];
            
            let mainMetric = policy.quality_attribute || "N/A";
            const boundary = policy.adaptation_boundary || {};
            let threshold = boundary.threshold;
            let thresholdData = [];
            
            const dataLength = telemetry.length;
            const sliceStart = Math.max(0, dataLength - CHART_MAX_DATA_POINTS);
            const limitedTelemetry = telemetry.slice(sliceStart);
            
            const labels = limitedTelemetry.map(t => new Date(t.timestamp * 1000));
            
            // === DEFINE VALID MODELS BASED ON CURRENT MODE ===
            // This whitelist acts as a firewall against "ghost" data
            let validModels = null;
            if (currentPolicyId && currentPolicyId.includes('cv_')) {
                validModels = ['yolo_n', 'yolo_s', 'yolo_m', 'unknown'];
            } else if (currentPolicyId && currentPolicyId.includes('reg_')) {
                validModels = ['svm', 'lstm', 'linear', 'unknown'];
            }

            // --- 1. Generate Annotations with STRICT FILTER ---
            const annotations = {};
            let annotationCount = 0;
            
            const minTimestamp = limitedTelemetry.length > 0 ? limitedTelemetry[0].timestamp : 0;
            const relevantInterventions = interventions.filter(i => 
                i.status === "CONFIRMED_SUCCESS" && i.timestamp >= minTimestamp
            );
            
            relevantInterventions.forEach(i => {
                const timestamp = new Date(i.timestamp * 1000);
                const tacticId = i.tactic_id.replace(/_/g, ' ').toUpperCase(); 
                
                // Find telemetry immediately following intervention to see new model
                const nextTelemetry = telemetry.find(t => t.timestamp >= i.timestamp);
                const rawModel = nextTelemetry && nextTelemetry.model_used ? nextTelemetry.model_used : "unknown";
                const switchedModel = rawModel.toUpperCase();

                // === STRICT FILTER FOR GRAPH ANNOTATIONS ===
                // If we are in CV mode, strictly HIDE any annotation that talks about SVM/LSTM
                if (validModels && !validModels.includes(rawModel.toLowerCase())) {
                    return; // Skip this annotation!
                }

                annotations[`line${annotationCount}`] = {
                    type: 'line',
                    mode: 'vertical',
                    scaleID: 'x',
                    value: timestamp,
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                        display: true,
                        content: [tacticId, `↳ Model: ${switchedModel}`],
                        position: 'start',
                        backgroundColor: 'rgba(16, 185, 129, 0.9)',
                        color: '#ffffff',
                        font: { size: 10, weight: 'bold' },
                        padding: 4,
                        rotation: -90,
                        yAdjust: 20
                    }
                };
                annotationCount++;
            });

            // --- 2. Main Chart Update ---
            const isSingleMode = currentPolicyId.includes('single');
            if (isSingleMode && policy.associated_qas && policy.associated_qas.length > 0) {
                mainMetric = policy.associated_qas[0];
                document.getElementById('main-chart-title').textContent = `Main Metric: ${mainMetric} (Monitor-Only)`;
            } else {
                document.getElementById('main-chart-title').textContent = `Main Metric: ${mainMetric}`;
                thresholdData = labels.map(() => threshold);
            }
            
            const mainMetricData = limitedTelemetry.map(t => t[mainMetric]);
            
            updateChart(chartInstances.main, labels, [
                {
                    label: mainMetric,
                    data: mainMetricData,
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f6',
                    tension: 0.1,
                    pointRadius: 2
                },
                {
                    label: 'Threshold',
                    data: thresholdData,
                    borderColor: '#ef4444',
                    backgroundColor: '#ef4444',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ], { 
                plugins: { 
                    annotation: { 
                        annotations: annotations 
                    } 
                }
            });

            // --- 3. Pie Chart (Model Distribution) with STRICT FILTER ---
            const qaNames = policy.associated_qas ? [...policy.associated_qas] : [];
            const modelChartIndex = qaNames.indexOf('model_used');
            
            if (modelChartIndex > -1) {
                qaNames.splice(modelChartIndex, 1); 
                
                const modelCounts = {};
                telemetry.forEach(t => { 
                    const model = t['model_used'];
                    if (model) {
                        // === STRICT FILTER FOR PIE CHART ===
                        // If model is "svm" but we are in "cv_" mode, IGNORE IT.
                        if (validModels && !validModels.includes(model.toLowerCase())) {
                            return; 
                        }
                        
                        modelCounts[model] = (modelCounts[model] || 0) + 1;
                    }
                });
                const modelLabels = Object.keys(modelCounts);
                const modelData = Object.values(modelCounts);

                updateChart(chartInstances.modelChart, modelLabels, [{
                    label: 'Model Usage',
                    data: modelData,
                    backgroundColor: ['#3b82f6', '#10b981', '#eab308', '#a855f7', '#f472b6', '#6b7280'],
                }]);
            } else {
                updateChart(chartInstances.modelChart, [], []);
            }
            
            // --- Associated QA Line Charts ---
            const qaCharts = [chartInstances.qa1, chartInstances.qa2];
            const qaTitles = ['qa1-chart-title', 'qa2-chart-title'];
            const qaColors = ['#10b981', '#eab308'];

            qaNames.forEach((qaName, index) => {
                if (index < qaCharts.length) { 
                    const qaChart = qaCharts[index];
                    const qaTitle = qaTitles[index];
                    if (qaChart && qaTitle) {
                        document.getElementById(qaTitle).textContent = qaName || `Associated QA ${index+1}`;
                        const qaData = limitedTelemetry.map(t => t[qaName]);
                        updateChart(qaChart, labels, [{
                            label: qaName,
                            data: qaData,
                            borderColor: qaColors[index],
                            backgroundColor: qaColors[index],
                            tension: 0.1
                        }]);
                    }
                }
            });

            // Clear unused line charts
            for (let i = qaNames.length; i < qaCharts.length; i++) {
                const qaChart = qaCharts[i];
                const qaTitle = qaTitles[i];
                if (qaChart && qaTitle) {
                    document.getElementById(qaTitle).textContent = `Associated QA ${i+1}`;
                    updateChart(qaChart, [], []);
                }
            }
        }
        
        // ▼▼▼ 4. UPDATECHART FUNCTION (accepts options for annotations) ▼▼▼
        function updateChart(chart, labels, datasets, extraOptions = {}) {
            if (chart.config.type === 'doughnut') {
                chart.data.labels = labels;
                chart.data.datasets = datasets;
            } 
            else {
                const dataLength = labels.length;
                const sliceStart = Math.max(0, dataLength - CHART_MAX_DATA_POINTS);
                
                chart.data.labels = labels.slice(sliceStart);
                chart.data.datasets = datasets.map(ds => ({
                    ...ds,
                    data: ds.data.slice(sliceStart)
                }));
                
                if (extraOptions.plugins && extraOptions.plugins.annotation) {
                    chart.options.plugins.annotation.annotations = extraOptions.plugins.annotation.annotations;
                } else if (chart.options.plugins.annotation) {
                     chart.options.plugins.annotation.annotations = {};
                }
            }
            chart.update();
        }

        // === API & DATA HANDLING ===

        async function loadPolicy() {
            const policyId = policyIdInput.value;
            if (!policyId) {
                showMessage("Please enter a Policy ID.", "error");
                return;
            }
            
            currentPolicyId = policyId;
            document.getElementById('policy-title-dashboard').textContent = `Policy: ${policyId}`;

            if (pollingIntervalId) {
                clearInterval(pollingIntervalId);
            }

            await fetchKnowledge();
            pollingIntervalId = setInterval(fetchKnowledge, POLLING_INTERVAL);
        }

        async function fetchKnowledge() {
            if (!currentPolicyId) return;

            // Capture the ID we are requesting RIGHT NOW
            const requestedPolicyId = currentPolicyId;

            try {
                // Add timestamp to prevent caching
                const response = await fetch(`${ACP_SERVER_URL}/api/knowledge/${requestedPolicyId}?t=${Date.now()}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showMessage(`Policy '${requestedPolicyId}' not found on server.`, "warning");
                    } 
                    return;
                }
                
                const data = await response.json();

                // === RACE CONDITION FIX ===
                // If the user switched policies while this fetch was traveling over the network,
                // currentPolicyId will have changed. We MUST ignore this stale data.
                if (currentPolicyId !== requestedPolicyId) {
                    console.log(`Ignoring stale data for ${requestedPolicyId} (Current is: ${currentPolicyId})`);
                    return;
                }
                
                globalKnowledge = data;
                
                updateDashboardCharts(data);
                updatePolicyForm(data);
                updateHistoryFeed(data);

                if (data.policy) {
                    showMessage(`Successfully loaded policy '${currentPolicyId}'. Last updated: ${new Date().toLocaleTimeString()}`, "success");
                }

            } catch (error) {
                console.error("Failed to fetch knowledge:", error);
                // Only show error if we are still on the expected policy
                if (currentPolicyId === requestedPolicyId) {
                    showMessage(`Failed to connect to ACP server at ${ACP_SERVER_URL}. Is it running?`, "error");
                }
                if (pollingIntervalId) clearInterval(pollingIntervalId);
            }
        }

        function showMessage(text, type = "info") {
            messageContainer.textContent = text;
            messageContainer.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-yellow-100', 'bg-blue-100', 'text-red-800', 'text-green-800', 'text-yellow-800', 'text-blue-800');
            
            let bgColor = 'bg-blue-100'; // default info
            let textColor = 'text-blue-800';
            if (type === "error") {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
            } else if (type === "success") {
                bgColor = 'bg-green-100'; 
                textColor = 'text-green-800';
            } else if (type === "warning") {
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-800';
            }
            messageContainer.classList.add(bgColor, textColor, 'border', 'border-gray-300');
            messageContainer.classList.remove('hidden');
        }

        // === POLICY MANAGEMENT (KR1) ===

        function getPolicyFromForm() {
            const policy = {
                policy_id: document.getElementById('form-policy-id').value,
                quality_attribute: document.getElementById('form-metric').value,
                adaptation_boundary: {
                    type: "STATIC_THRESHOLD",
                    condition: document.getElementById('form-condition').value,
                    threshold: parseFloat(document.getElementById('form-threshold').value)
                },
                tactics: [],
                secondary_boundaries: [], 
                associated_qas: document.getElementById('form-qas').value.split(',').filter(qa => qa.trim() !== "").map(qa => qa.trim())
            };

            document.querySelectorAll('.tactic-group').forEach(group => {
                policy.tactics.push({
                    tactic_id: group.querySelector('.tactic-id').value,
                    priority: parseInt(group.querySelector('.tactic-priority').value),
                    tactic_type: "CORE",
                    tactic_endpoint: group.querySelector('.tactic-endpoint').value
                });
            });

            document.querySelectorAll('.secondary-boundary-group').forEach(group => {
                const metric = group.querySelector('.sec-boundary-metric').value;
                if (metric) {
                    policy.secondary_boundaries.push({
                        quality_attribute: metric,
                        condition: group.querySelector('.sec-boundary-condition').value,
                        threshold: parseFloat(group.querySelector('.sec-boundary-threshold').value),
                        tactic_id: group.querySelector('.sec-boundary-tactic-id').value
                    });
                }
            });
            
            return policy;
        }

        function updatePolicyForm(data) {
            const policy = data.policy || { policy_id: currentPolicyId };
            
            document.getElementById('form-policy-id').value = policy.policy_id || currentPolicyId;
            document.getElementById('form-metric').value = policy.quality_attribute || '';
            document.getElementById('form-qas').value = (policy.associated_qas || []).join(',');

            const boundary = policy.adaptation_boundary || {};
            document.getElementById('form-condition').value = boundary.condition || 'LESS_THAN';
            document.getElementById('form-threshold').value = boundary.threshold || 0;

            const tactics = policy.tactics || [];
            tacticsContainer.innerHTML = '';
            
            if (tactics.length === 0) {
                addTacticGroup();
            } else {
                tactics.forEach((tactic, index) => {
                    addTacticGroup(tactic, index + 1);
                });
            }

            const secBoundaries = policy.secondary_boundaries || [];
            secondaryBoundariesContainer.innerHTML = '';

            if (secBoundaries.length === 0) {
                addSecBoundaryGroup(null, 1); 
                secondaryBoundariesContainer.querySelector('.secondary-boundary-group').remove(); 
            } else {
                secBoundaries.forEach((boundary, index) => {
                    addSecBoundaryGroup(boundary, index + 1);
                });
            }
        }
        
        async function handlePolicySubmit(event) {
            event.preventDefault();
            showMessage("Sending policy to server...", "info");

            try {
                const policy = getPolicyFromForm();
                
                const response = await fetch(`${ACP_SERVER_URL}/api/policy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(policy)
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }

                showMessage("Policy successfully created/updated!", "success");
                
                if (currentPolicyId !== policy.policy_id) {
                    policyIdInput.value = policy.policy_id;
                    loadPolicy();
                }

            } catch (error) {
                console.error("Failed to submit policy:", error);
                showMessage(`Failed to submit policy: ${error.message}`, "error");
            }
        }
        
        function populateFormWithPreset(preset) {
            document.getElementById('form-policy-id').value = preset.policy_id || '';
            document.getElementById('form-metric').value = preset.quality_attribute || '';
            document.getElementById('form-qas').value = (preset.associated_qas || []).join(',');
        
            const boundary = preset.adaptation_boundary || {};
            document.getElementById('form-condition').value = boundary.condition || 'LESS_THAN';
            document.getElementById('form-threshold').value = boundary.threshold || 0;
        
            const tactics = preset.tactics || [];
            tacticsContainer.innerHTML = '';

            if (tactics.length === 0) {
                addTacticGroup();
            } else {
                tactics.forEach((tactic, index) => {
                    addTacticGroup(tactic, index + 1);
                });
            }

            const secBoundaries = preset.secondary_boundaries || [];
            secondaryBoundariesContainer.innerHTML = '';

            if (secBoundaries.length > 0) {
                secBoundaries.forEach((boundary, index) => {
                    addSecBoundaryGroup(boundary, index + 1);
                });
            }
            updateSecBoundaryHeaders();

            setFieldsEditability(false);
        }

        function setFieldsEditability(isCustom) {
            const policyIdField = document.getElementById('form-policy-id');
            const metricField = document.getElementById('form-metric');
            
            if (isCustom) {
                policyIdField.removeAttribute('readonly');
                metricField.removeAttribute('readonly');
                policyIdField.classList.remove('bg-gray-600', 'cursor-not-allowed');
                metricField.classList.remove('bg-gray-600', 'cursor-not-allowed');
                policyIdField.classList.add('bg-gray-700');
                metricField.classList.add('bg-gray-700');
                addSecBoundaryBtn.classList.remove('hidden');
                document.querySelectorAll('.remove-sec-boundary-btn').forEach(btn => btn.classList.remove('hidden'));
            } else {
                policyIdField.setAttribute('readonly', true);
                metricField.setAttribute('readonly', true);
                policyIdField.classList.remove('bg-gray-700');
                metricField.classList.remove('bg-gray-700');
                policyIdField.classList.add('bg-gray-600', 'cursor-not-allowed');
                metricField.classList.add('bg-gray-600', 'cursor-not-allowed');
                addSecBoundaryBtn.classList.add('hidden');
                document.querySelectorAll('.remove-sec-boundary-btn').forEach(btn => btn.classList.add('hidden'));
            }
        }

        function handlePolicyDownload() {
            try {
                const policy = getPolicyFromForm();
                const policyId = policy.policy_id;

                if (!policyId || !policy.quality_attribute) {
                    showMessage("Please fill in at least 'Policy ID' and 'Metric to Watch'.", "error");
                    return;
                }

                const policyString = JSON.stringify(policy, null, 2);
                const blob = new Blob([policyString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${policyId}.json`;
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage(`${policyId}.json downloaded! Move it to your 'policies' folder.`, "success");

            } catch (error) {
                console.error("Failed to generate policy:", error);
                showMessage(`Failed to generate policy: ${error.message}`, "error");
            }
        }

        function handleTelemetryDownload() {
            const telemetry = globalKnowledge.telemetry_history;
            if (!telemetry || telemetry.length === 0) {
                showMessage("No telemetry data to download.", "warning");
                return;
            }
        
            try {
                const allKeys = new Set();
                telemetry.forEach(row => Object.keys(row).forEach(key => allKeys.add(key)));
                const keys = Array.from(allKeys);

                const csvContent = [
                    keys.join(','), 
                    ...telemetry.map(row => 
                        keys.map(key => {
                            let cell = row[key];
                            if (cell === undefined || cell === null) {
                                return "";
                            }
                            if (typeof cell === 'string' && cell.includes(',')) {
                                return `"${cell}"`;
                            }
                            return cell;
                        }).join(',')
                    )
                ].join('\n');
        
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentPolicyId || 'telemetry'}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage("Telemetry CSV downloaded!", "success");
        
            } catch (error) {
                console.error("Failed to generate telemetry CSV:", error);
                showMessage(`Failed to generate CSV: ${error.message}`, "error");
            }
        }


        function addTacticGroup(tactic = null, index = null) {
            const tacticCount = index || tacticsContainer.children.length + 1;
            const newTacticGroup = document.createElement('div');
            newTacticGroup.className = 'tactic-group border border-gray-200 p-3 rounded-md space-y-2 bg-gray-50';
            newTacticGroup.innerHTML = `
                <h4 class="font-medium text-gray-700">Tactic ${tacticCount}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Tactic ID</label>
                        <input type="text" class="tactic-id w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${tactic?.tactic_id || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Priority</label>
                        <input type="number" value="${tactic?.priority || tacticCount}" class="tactic-priority w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1 text-gray-700">Tactic Endpoint URL</label>
                        <input type="text" class="tactic-endpoint w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${tactic?.tactic_endpoint || 'http://localhost:8080/adaptor/tactic'}" required>
                    </div>
                    <div class="flex items-end">
                        <button type="button" class="remove-tactic-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm">Remove</button>
                    </div>
                </div>
            `;
            tacticsContainer.appendChild(newTacticGroup);
        }

        function updateTacticHeaders() {
            document.querySelectorAll('.tactic-group').forEach((group, index) => {
                group.querySelector('h4').textContent = `Tactic ${index + 1}`;
                group.querySelector('.tactic-priority').value = index + 1;
            });
        }

        function addSecBoundaryGroup(boundary = null, index = null) {
            const boundaryCount = index || secondaryBoundariesContainer.children.length + 1;
            const newBoundaryGroup = document.createElement('div');
            newBoundaryGroup.className = 'secondary-boundary-group border border-gray-200 p-3 rounded-md space-y-2 bg-gray-50';
            newBoundaryGroup.innerHTML = `
                <h4 class="font-medium text-gray-700">Secondary Boundary ${boundaryCount}</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Metric (QA)</label>
                        <input type="text" class="sec-boundary-metric w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${boundary?.quality_attribute || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Condition</label>
                        <select class="sec-boundary-condition w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="LESS_THAN" ${boundary?.condition === 'LESS_THAN' ? 'selected' : ''}>LESS_THAN</option>
                            <option value="GREATER_THAN" ${boundary?.condition === 'GREATER_THAN' ? 'selected' : ''}>GREATER_THAN</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Threshold</label>
                        <input type="number" step="0.01" class="sec-boundary-threshold w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${boundary?.threshold || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Tactic ID</label>
                        <input type="text" class="sec-boundary-tactic-id w-full bg-white border border-gray-300 rounded-md p-2 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${boundary?.tactic_id || ''}" required>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" class="remove-sec-boundary-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm">Remove</button>
                </div>
            `;
            secondaryBoundariesContainer.appendChild(newBoundaryGroup);
            setFieldsEditability(currentPolicyId === "my_custom_policy" || !Object.keys(HARMONY_PRESETS).includes(currentPolicyId));
        }

        function updateSecBoundaryHeaders() {
            document.querySelectorAll('.secondary-boundary-group').forEach((group, index) => {
                group.querySelector('h4').textContent = `Secondary Boundary ${index + 1}`;
            });
        }


        // === ADAPTATION HISTORY (KR3) ===

        function updateHistoryFeed(data) {
            const feed = document.getElementById('history-feed');
            const interventions = data.intervention_logs || [];
            const telemetry = data.telemetry_history || [];
            const policy = data.policy || {};

            if (interventions.length === 0) {
                feed.innerHTML = '<div class="text-gray-500">No adaptation events recorded yet.</div>';
                return;
            }

            feed.innerHTML = '';
            interventions.slice().reverse().forEach((event, index) => {
                const card = createHistoryCard(event, index, telemetry, policy);
                feed.appendChild(card);
            });
            
            interventions.slice().reverse().forEach((event, index) => {
                renderHistoryChart(event, index, telemetry, policy);
            });
        }
        
        function createHistoryCard(event, index, telemetry, policy) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-lg card-shadow border border-gray-200';
            
            const statusColor = event.status === "CONFIRMED_SUCCESS" ? "text-green-600" : (event.status.includes("FAILED") ? "text-red-600" : "text-yellow-600");
            
            const primaryBoundary = policy.adaptation_boundary || {};
            const secondaryBoundary = (policy.secondary_boundaries || []).find(b => b.quality_attribute === event.trigger_metric);
            
            let displayMetric = policy.quality_attribute;
            let displayCondition = primaryBoundary.condition;
            let displayThreshold = primaryBoundary.threshold;

            if (secondaryBoundary && event.trigger_metric !== displayMetric) {
                displayMetric = event.trigger_metric;
                displayCondition = secondaryBoundary.condition;
                displayThreshold = secondaryBoundary.threshold;
            } else {
                displayMetric = policy.quality_attribute || 'N/A';
            }
            
            const triggerValue = event.trigger_value ? parseFloat(event.trigger_value).toFixed(2) : 'N/A';

            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Adaptation Event</h3>
                    <span class="text-sm font-mono ${statusColor}">${event.status}</span>
                </div>
                <div class="text-sm text-gray-500 mb-4">${new Date(event.timestamp * 1000).toLocaleString()}</div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Violation Trigger</div>
                        <div class="text-lg font-semibold text-red-600">${displayMetric} (${triggerValue})</div>
                        <div class="text-sm text-gray-600">Adapt when ${displayCondition || ''} ${displayThreshold || ''}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Action Taken</div>
                        <div class="text-lg font-semibold text-blue-600">${event.tactic_id}</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Before & After Performance (${displayMetric})</h4>
                    <div class="h-40 bg-gray-50 p-2 rounded-md border border-gray-200">
                        <canvas id="history-chart-${index}"></canvas>
                    </div>
                </div>
            `;
            return card;
        }

        function renderHistoryChart(event, index, telemetry, policy) {
            const canvas = document.getElementById(`history-chart-${index}`);
            if (!canvas) return;

            const triggerMetric = event.trigger_metric || policy.quality_attribute;
            const eventTimestamp = event.timestamp;
            
            let eventIndex = telemetry.findIndex(t => t.timestamp >= eventTimestamp);
            if (eventIndex === -1) eventIndex = telemetry.length;

            const dataPointsToShow = 10;
            const startIndex = Math.max(0, eventIndex - dataPointsToShow);
            const endIndex = Math.min(telemetry.length, eventIndex + dataPointsToShow);

            const chartData = telemetry.slice(startIndex, endIndex);
            
            const labels = chartData.map(t => new Date(t.timestamp * 1000));
            const data = chartData.map(t => t[triggerMetric]);
            
            const eventLine = {
                type: 'line',
                mode: 'vertical',
                scaleID: 'x',
                value: new Date(eventTimestamp * 1000),
                borderColor: '#ef4444',
                borderWidth: 2,
                borderDash: [5, 5],
                label: {
                    content: 'Adaptation Event',
                    enabled: true,
                    position: 'start',
                    backgroundColor: '#ef4444'
                }
            };

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: triggerMetric,
                        data: data,
                        borderColor: '#3b82f6',
                        tension: 0.1,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            type: 'time',
                            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
                            ticks: { color: '#6b7280', maxTicksLimit: 6 },
                            grid: { color: '#e5e7eb' }
                        },
                        y: { 
                            ticks: { color: '#6b7280', maxTicksLimit: 5 },
                            grid: { color: '#e5e7eb' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                eventLine
                            }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        // === NEW: Approach Configuration Writer ===
        async function writeApproachConfig(approach) {
            try {
                const response = await fetch(`${ACP_SERVER_URL}/api/write-approach`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approach: approach })
                });

                if (response.ok) {
                    showMessage(` Approach configuration set to '${approach}'`, "success");
                    return true;
                } else {
                    throw new Error(`Failed to write config: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error writing approach config:', error);
                showMessage(` Auto-config failed. Manually set 'approach.conf' to '${approach}'`, "warning");
                return false;
            }
        }

        // === NEW: Policy File Saver ===
        async function savePolicyToFolder() {
            try {
                const policy = getPolicyFromForm();
                const policyId = policy.policy_id;

                if (!policyId || !policy.quality_attribute) {
                    showMessage("Please fill in at least 'Policy ID' and 'Metric to Watch'.", "error");
                    return;
                }

                const response = await fetch(`${ACP_SERVER_URL}/api/save-policy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(policy)
                });

                if (response.ok) {
                    showMessage(` Policy saved to policies/${policyId}.json`, "success");
                    return true;
                } else {
                    throw new Error(`Failed to save policy: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error saving policy:', error);
                showMessage(` Failed to save policy file: ${error.message}`, "error");
                return false;
            }
        }

        // === MODAL FUNCTIONS FOR SINGLE MODEL SELECTION ===
        function showModelSelectionModal() {
            const modelOptions = getModelOptions(currentSystemType);
            modelDropdown.innerHTML = '';
            
            modelOptions.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelDropdown.appendChild(option);
            });
            
            modelSelectionModal.classList.remove('hidden');
        }

        function hideModelSelectionModal() {
            modelSelectionModal.classList.add('hidden');
            currentSystemType = "";
        }

        function getModelOptions(systemType) {
            if (systemType === "regression") {
                return [
                    { value: "svm", label: "SVM - Support Vector Machine" },
                    { value: "lstm", label: "LSTM - Long Short-Term Memory" },
                    { value: "linear", label: "Linear - Linear Regression" }
                ];
            } else if (systemType === "cv") {
                return [
                    { value: "yolo_n", label: "YOLO Nano - Fast & Lightweight" },
                    { value: "yolo_s", label: "YOLO Small - Balanced" },
                    { value: "yolo_m", label: "YOLO Medium - High Accuracy" }
                ];
            }
            return [];
        }

        async function runManagedSystem() {
            try {
                const response = await fetch("http://localhost:5000/api/start-managed-system", {
                    method: "POST",
                });
        
                const data = await response.json();
                showMessage(data.message, "success");
            } catch (err) {
                showMessage("Could not start managed system: " + err, "error");
            }
        }
        
        async function handleModelSelection() {
            const selectedModel = modelDropdown.value;
            if (!selectedModel) {
                showMessage("Please select a model.", "error");
                return;
            }
        
            // 1. Reset knowledge first
            await resetServerKnowledge(); 

            let singlePreset;
            let approachConfig;
            
            // Define the presets based on system type
            if (currentSystemType === "regression") {
                singlePreset = {
                    policy_id: `reg_single_${selectedModel}`,
                    quality_attribute: 'r2_score',
                    adaptation_boundary: { condition: "LESS_THAN", threshold: 0.0 },
                    tactics: [],
                    secondary_boundaries: [],
                    associated_qas: ['r2_score', 'normalized_energy', 'model_used']
                };
                approachConfig = 'reg_single';
            } else if (currentSystemType === "cv") {
                singlePreset = {
                    policy_id: `cv_single_${selectedModel}`,
                    quality_attribute: 'confidence',
                    adaptation_boundary: { condition: "LESS_THAN", threshold: 0.0 },
                    tactics: [],
                    secondary_boundaries: [],
                    associated_qas: ['confidence', 'normalized_energy', 'model_used']
                };
                approachConfig = 'cv_single';
            }
        
            try {
                showMessage(`Configuring single model mode with ${selectedModel.toUpperCase()}...`, "info");
        
                // 2. MOVED UP: Write approach FIRST.
                // This function clears the server's Knowledge Base, so it must happen 
                // BEFORE we register the new policy.
                await writeApproachConfig(approachConfig);

                // 3. Set the specific model file
                await setSelectedModel(selectedModel, currentSystemType);
                
                // 4. Update the form UI (for visual feedback)
                populateFormWithPreset(singlePreset);
                policyIdInput.value = singlePreset.policy_id;
                
                // 5. Register the Policy (Now it won't be deleted)
                const policyResponse = await fetch(`${ACP_SERVER_URL}/api/policy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(singlePreset)
                });
        
                if (!policyResponse.ok) {
                    throw new Error(`Failed to create policy: ${policyResponse.statusText}`);
                }
        
                // 6. Save policy to disk (optional but good for persistence)
                await savePolicyToFolder();
                
                // 7. Start the system
                showMessage("Starting managed system...", "info");
                await runManagedSystem();
                
                // 8. Update View
                hideModelSelectionModal();
                showView('dashboard');
                
                currentPolicyId = singlePreset.policy_id;
                document.getElementById('policy-title-dashboard').textContent = `Policy: ${singlePreset.policy_id}`;
                
                if (pollingIntervalId) {
                    clearInterval(pollingIntervalId);
                }
                await fetchKnowledge();
                pollingIntervalId = setInterval(fetchKnowledge, POLLING_INTERVAL);
                
                document.querySelector('.tab-btn[data-tab="dashboard"]').click();
                
                showMessage(`Single model mode started! Using ${selectedModel.toUpperCase()} - monitoring ${singlePreset.quality_attribute}`, "success");
                
            } catch (error) {
                console.error('Error configuring single model:', error);
                showMessage(`Failed to configure single model: ${error.message}`, "error");
                hideModelSelectionModal();
            }
        }

        async function setSelectedModel(modelName, systemType) {
            try {
                const response = await fetch(`${ACP_SERVER_URL}/api/set-model`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName, system: systemType })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`Model set successfully: ${result.message}`);
                } else {
                    throw new Error(`Failed to set model: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error setting model:', error);
                showMessage(`Failed to set model: ${error.message}`, "warning");
            }
        }

        document.getElementById("adaptive-start-btn").addEventListener("click", async () => {
            showMessage("Starting managed system...", "info");
            await runManagedSystem();
            
            document.getElementById("adaptive-start-container").classList.add("hidden");
            
            if (policyIdInput.value) {
                currentPolicyId = policyIdInput.value;
                document.getElementById('policy-title-dashboard').textContent = `Policy: ${currentPolicyId}`;
                
                if (pollingIntervalId) {
                    clearInterval(pollingIntervalId);
                }
                
                await fetchKnowledge();
                pollingIntervalId = setInterval(fetchKnowledge, POLLING_INTERVAL);
                
                document.querySelector('.tab-btn[data-tab="dashboard"]').click();
                
                showMessage(`Managed system started! Monitoring policy: ${currentPolicyId}`, "success");
            }
        });
        
    </script>
</body>
</html>